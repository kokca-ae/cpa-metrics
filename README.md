# CPA Metrics Schema

## Описание решения

Схема хранит данные о CPA-кампаниях в PostgreSQL.

- `cpa_metrics_raw` — сырые события (клики, конверсии)
- `cpa_metrics_daily` — агрегированные показатели по дате и источнику

Нормализованы таблицы:
- `advertisers` — рекламодатели
- `campaigns` — кампании
- `traffic_sources` — источники трафика

Используется JSONB для дополнительных данных (`extra_data`) и TIMESTAMPTZ для корректного хранения времени.

## Плюсы

1. Быстрая аналитика через агрегированную таблицу `cpa_metrics_daily`.
2. Хранение детальных данных в `cpa_metrics_raw` для аудита.
3. Расширяемость через JSONB (`extra_data`) для новых полей.
4. Индексация по кампании, источнику и дате ускоряет выборки.
5. Надёжность: внешние ключи и ограничения уникальности.
6. Агрегация атомарная через `ON CONFLICT`.

## Минусы

1. Требуется регулярный ETL-процесс для обновления агрегатов.
2. Дополнительное место на диске для сырых и агрегированных данных.
3. Для экстремально больших объемов данных возможно партиционирование или OLAP-хранилище.
4. Сложная аналитика по произвольным JSONB-полям медленнее, чем по отдельным колонкам.

## Возможная оптимизация

Для больших объемов данных и сложной аналитики можно добавить:

- Партиционирование таблицы `cpa_metrics_raw` по дате.
- Отдельные колонки для часто фильтруемых параметров (`region`, `device`, `utm_source`) вместо хранения только в JSONB.
- Материализованные представления для агрегатов (`cpa_metrics_daily_mv`) вместо ручного ETL.
- Индексы с выражениями и покрывающие индексы для ускорения агрегированных выборок.